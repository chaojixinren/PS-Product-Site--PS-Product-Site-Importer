<div id="ps-product-site">
  <style>
    #ps-product-site { font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","PingFang SC","Hiragino Sans GB","Microsoft Yahei",sans-serif; padding: 16px; }
    .ps-container { max-width: 1200px; margin: 0 auto; }
    .ps-topbar { position: sticky; top: 0; z-index: 2; background: transparent; margin-bottom: 16px; }
    .ps-search-wrap { display: flex; gap: 12px; align-items: center; margin-bottom: 10px; }
    .ps-search { flex: 1; position: relative; }
    .ps-search input { width: 100%; height: 44px; border-radius: 999px; border: 1px solid #e5e7eb; padding: 0 44px 0 16px; outline: none; background:#fff; }
    .ps-search input:focus { border-color: #2563eb; box-shadow: 0 0 0 3px rgba(37,99,235,.15); }
    .ps-search .hint { position: absolute; right: 14px; top: 50%; transform: translateY(-50%); font-size: 12px; color: #6b7280; }
    .ps-chips { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 4px; scrollbar-width: thin; }
    .ps-chip { flex: 0 0 auto; padding: 8px 14px; border-radius: 999px; border: 1px solid #e5e7eb; background: #fff; cursor: pointer; user-select: none; }
    .ps-chip.active { border-color: #2563eb; background: #eff6ff; color: #1d4ed8; }
    .ps-strip { margin-top: 10px; display: flex; gap: 10px; overflow-x: auto; padding-bottom: 6px; scrollbar-width: thin; }
    .ps-pill { flex: 0 0 auto; min-width: 240px; max-width: 280px; border-radius: 14px; border: 1px solid #e5e7eb; background: #fff; padding: 12px; cursor: pointer; transition: box-shadow .2s, transform .2s; }
    .ps-pill:hover { box-shadow: 0 8px 24px rgba(0,0,0,.06); transform: translateY(-2px); }
    .ps-pill-title { font-weight: 700; color: #111827; margin-bottom: 6px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .ps-pill-desc { color: #6b7280; font-size: 12px; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .ps-hero { margin-top: 16px; background: #0f3a86; color: #fff; border-radius: 28px; padding: 28px; }
    .ps-hero-inner { display: grid; grid-template-columns: 1.3fr .7fr; gap: 24px; align-items: center; }
    .ps-hero h2 { font-size: 32px; line-height: 1.2; margin: 0 0 16px; }
    .ps-hero p { color: #e5e7eb; line-height: 1.8; margin: 0; }
    .ps-hero .ps-badge { display: inline-block; background:#e6efff; color:#0f3a86; border-radius: 999px; padding: 6px 12px; font-weight:700; margin-bottom: 12px; }
    .ps-hero-img { background: #fff; border-radius: 18px; display:flex; align-items:center; justify-content:center; padding: 18px; min-height: 240px; }
    .ps-hero-img img { max-width: 100%; height: auto; display:block; }
    .skeleton { background: linear-gradient(90deg, rgba(0,0,0,.06) 25%, rgba(0,0,0,.12) 37%, rgba(0,0,0,.06) 63%); background-size: 400% 100%; animation: shimmer 1.4s ease infinite; }
    @keyframes shimmer { 0%{background-position: 100% 0} 100%{background-position: -100% 0} }
    @media (max-width: 900px){ .ps-hero-inner { grid-template-columns: 1fr; } }
  </style>

  <div class="ps-container">
    <div class="ps-topbar">
      <div class="ps-search-wrap">
        <div class="ps-search">
          <input id="ps-search-input" type="search" placeholder="搜索产品名称、型号或参数（含表格参数）">
          <span class="hint">⌘/Ctrl+K</span>
        </div>
      </div>
      <div id="ps-chips" class="ps-chips"></div>
      <div id="ps-strip" class="ps-strip"></div>
    </div>

    <div id="ps-hero" class="ps-hero" style="display:none;">
      <div class="ps-hero-inner">
        <div class="ps-hero-text">
          <div id="ps-hero-cat" class="ps-badge" style="display:none;"></div>
          <h2 id="ps-hero-title">Title</h2>
          <p id="ps-hero-desc">Desc</p>
        </div>
        <div class="ps-hero-img">
          <img id="ps-hero-img" alt="product image" onerror="this.style.display='none'">
        </div>
      </div>
    </div>
  </div>

  <script>
  (function(){
    const ENDPOINT = '__PS_PRODUCTS_ENDPOINT__';
    const $ = s => document.querySelector(s);
    const elChips = $('#ps-chips');
    const elStrip = $('#ps-strip');
    const elSearch = $('#ps-search-input');
    const elHero = $('#ps-hero');
    const elHeroCat = $('#ps-hero-cat');
    const elHeroTitle = $('#ps-hero-title');
    const elHeroDesc = $('#ps-hero-desc');
    const elHeroImg = $('#ps-hero-img');
    const state = { products: [], view: [], cats: [], cat: '全部', q: '' };

    function stripHtml(html){
      if(!html) return '';
      const tmp = document.createElement('div'); tmp.innerHTML = html;
      return (tmp.textContent||tmp.innerText||'').replace(/\s+/g,' ').trim();
    }
    function buildIndex(p){
      const fields = [p.title, p.sub, p.desc, p.A6, p.A7, p.A9, p.A10, p.A12, p['Unnamed:_17'], p['Unnamed:_18'], stripHtml(p.table1), stripHtml(p.table2)];
      return fields.filter(Boolean).join(' ').toLowerCase();
    }
    function indexProducts(list){ list.forEach(p => p._blob = buildIndex(p)); }
    function uniq(arr){ return Array.from(new Set(arr)); }

    function renderChips(){
      const cats = ['全部', ...state.cats];
      elChips.innerHTML = cats.map(c => '<div class="ps-chip'+(c===state.cat?' active':'')+'" data-cat="'+c+'">'+c+'</div>').join('');
      elChips.onclick = (e)=>{
        const chip = e.target.closest('.ps-chip'); if(!chip) return;
        state.cat = chip.dataset.cat; renderChips(); filterAndRender();
      };
    }
    function renderStrip(list){
      if(!list.length){ elStrip.innerHTML = '<div style="color:#6b7280">没有匹配的产品</div>'; return; }
      elStrip.innerHTML = list.map(p => (
        '<div class="ps-pill" data-id="'+p.id+'">'
          +'<div class="ps-pill-title">'+(p.title||'')+'</div>'
          +'<div class="ps-pill-desc">'+(p.desc||'')+'</div>'
        +'</div>'
      )).join('');
      elStrip.onclick = e=>{
        const it = e.target.closest('.ps-pill'); if(!it) return;
        const id = it.getAttribute('data-id');
        const p = state.view.find(x=>String(x.id)===String(id));
        if(p) showHero(p);
      };
    }
    function showHero(p){
      elHeroTitle.textContent = p.title || '';
      elHeroDesc.textContent = p.desc || '';
      if(p['内容栏目']){ elHeroCat.textContent = p['内容栏目']; elHeroCat.style.display='inline-block'; } else { elHeroCat.style.display='none'; }
      if(p.img1){ elHeroImg.src = p.img1; elHeroImg.style.display='block'; } else { elHeroImg.style.display='none'; }
      elHero.style.display = 'block';
      if(window.parent){ setTimeout(()=>{ try{ parent.postMessage({type:'ps-resize', id:'inline', h:document.body.scrollHeight }, '*'); }catch(e){} }, 50); }
    }
    function filterAndRender(){
      const q = state.q.trim().toLowerCase();
      const terms = q ? q.split(/\s+/).filter(Boolean) : [];
      state.view = state.products.filter(p=>{
        const catOk = (state.cat==='全部') || (p['内容栏目']===state.cat);
        if(!catOk) return false;
        if(!terms.length) return true;
        return terms.every(t => p._blob.indexOf(t) !== -1);
      });
      renderStrip(state.view);
      if(state.view.length) showHero(state.view[0]);
    }
    let t; elSearch.addEventListener('input', ()=>{ clearTimeout(t); t=setTimeout(()=>{ state.q = elSearch.value || ''; filterAndRender(); }, 200); });
    window.addEventListener('keydown', e=>{ if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='k'){ e.preventDefault(); elSearch.focus(); } });
    function fetchProducts(){ return fetch(ENDPOINT, {credentials:'same-origin'}).then(r=>r.json()); }
    fetchProducts().then(list=>{
      state.products = Array.isArray(list) ? list : [];
      state.cats = uniq(state.products.map(p => p['内容栏目'] || '未分类')).filter(Boolean);
      indexProducts(state.products);
      renderChips(); filterAndRender();
    }).catch(err=>{ elStrip.innerHTML = '<div style="color:#ef4444">数据加载失败</div>'; console.error('ps products error:', err); });
  })();
  </script>
</div>
